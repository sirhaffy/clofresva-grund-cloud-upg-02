---
- name: Configure App Server
  hosts: app_server
  become: yes
  tasks:
    - name: Add .NET 9.0 backports repository
      apt_repository:
        repo: "ppa:dotnet/backports"
        state: present
      when: ansible_os_family == "Debian"

    - name: Update apt cache
      apt:
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Install ASP.NET Core Runtime
      apt:
        name: aspnetcore-runtime-9.0
        state: present
      when: ansible_os_family == "Debian"

    # Create app directory
    - name: Create app directory
      file:
        path: /var/www/app
        state: directory
        mode: '0755'
        owner: www-data
        group: www-data

    # Configure blob storage settings
    - name: Configure blob storage settings
      template:
        src: ../templates/appsettings.Production.json.j2
        dest: /var/www/app/appsettings.Production.json
        owner: www-data
        group: www-data
        mode: '0644'

    # Create web app service
    - name: Create app service file
      template:
        src: ../templates/webapp.service.j2
        dest: /etc/systemd/system/webapp.service
        owner: root
        group: root
        mode: '0644'

    # Open port for web service
    - name: Open port 5000 in firewall
      ufw:
        rule: allow
        port: '5000'
        proto: tcp

    # GITHUB ACTIONS RUNNER SETUP - DETTA Ã„R DEN VIKTIGA DELEN ATT FIXA
    # Install required dependencies for GitHub Actions runner
    - name: Install required dependencies for GitHub Actions runner
      apt:
        name:
          - curl
          - jq
          - sudo
          - tar
          - git
        state: present

    # Download the GitHub Actions runner
    - name: Download GitHub Actions runner
      get_url:
        url: https://github.com/actions/runner/releases/download/v2.311.0/actions-runner-linux-x64-2.311.0.tar.gz
        dest: /tmp/actions-runner-linux-x64-2.311.0.tar.gz
        mode: '0644'

    # Create GitHub Actions runner directory
    - name: Create GitHub Actions runner directory
      file:
        path: /opt/actions-runner
        state: directory
        mode: '0755'
        owner: azureuser
        group: azureuser

    # Extract GitHub Actions runner
    - name: Extract GitHub Actions runner
      unarchive:
        src: /tmp/actions-runner-linux-x64-2.311.0.tar.gz
        dest: /opt/actions-runner
        remote_src: yes
        owner: azureuser
        group: azureuser
        mode: '0755'

    # Configure GitHub Actions runner
    - name: Configure GitHub Actions runner
      become: yes
      become_user: azureuser
      shell: |
        cd /opt/actions-runner
        # Remove any existing runner configuration
        if [ -f ".runner" ]; then
          ./config.sh remove --token {{ github_runner_token }}
        fi
        # Configure the runner
        ./config.sh --url https://github.com/{{ github_repo }} --token {{ github_runner_token }} --name app-server-runner --labels self-hosted --unattended
      args:
        executable: /bin/bash
        creates: /opt/actions-runner/.runner

    # Install GitHub Actions runner as a service
    - name: Install GitHub Actions runner as a service
      become: yes
      command: /opt/actions-runner/svc.sh install azureuser
      args:
        creates: /etc/systemd/system/actions.runner.*

    # Enable and start GitHub Actions runner service
    - name: Enable GitHub Actions runner service
      systemd:
        name: actions.runner.*
        state: started
        enabled: yes
        daemon_reload: yes